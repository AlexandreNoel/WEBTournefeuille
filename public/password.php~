<?php

session_start() ;

function modification() {
    $ancien_password = $_POST["ancien_password"] ;
    $password = $_POST["password"] ;
    
    $nom_hote= "localhost" ; 
    $nom_base = getenv('DB_NAME'); 
    $nom_user = getenv('DB_USER');
    $mdp=getenv('DB_PASSWORD');
    $connection = new PDO("pgsql:host=postgres user=$nom_user dbname=$nom_base password=$mdp");

    $req1 = $connection->prepare("SELECT * FROM \"users\" WHERE username=? ;") ;
    $reponse1 = $req1->execute([$_SESSION['userName']]) ;
    if ($reponse1) {
       $row = $req->fetch() ;
       if ($row['password'] == $ancien_password) {
           $connection1 = new PDO("pgsql:host=postgres user=$nom_user dbname=$nom_base password=$mdp");
	   $user = $_SESSION['userName'] ;
           $req2 = $connection1->prepare("UPDATE \"users\" SET password=REPLACE(password, ?, ?) WHERE userName=? ;");
	   $reponse2 = $req2->execute([$ancien_password, $password, $user]) ;
	   if ($reponse2) {
               header('Location : accueilPerso.php') ;
	       exit() ;
           }
	   else {
               header('Location : changemdp.php') ;
	       exit() ;
           }
       }
       else {
           header('Location : changemdp.php') ;
	   exit() ;
       }
    }
    else {
        header('Location : changemdp.php') ;
	exit() ;
    }
}







?>